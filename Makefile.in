#!/bin/bash

INSTALL_DIR := @prefix@
srcdir := $(shell cd @top_srcdir@ && pwd)

BINUTILS_VERSION := 2.21.1
GCC_VERSION := 4.6.1
GLIBC_VERSION := 2.14.1
NEWLIB_VERSION := 1.18.0

GMP_VERSION := 5.1.2
MPC_VERSION := 1.0.1
MPFR_VERSION := 3.1.2

LINUX_DIR := $(srcdir)/linux-headers/

MAKE_JOBS := 16

ifndef INSTALL_DIR
busted: 
	@echo -e "\
You need to set INSTALL_DIR to point to where you want the tools \n\
installed. The best way to do this is to create a 'Makelocal' file\n\
in the current directory and put it in there.  Alternatively, specify\n\
it on the command line, like so:\n\
\n\
    make INSTALL_DIR=/your/install/path\n\
"; false
newlib: busted
riscv: busted
endif

# Check that we have gawk installed.  Set awk=gawk if necessary.
SHELL := /bin/sh
ifeq ($(shell awk --version | grep GNU),)
ifeq ($(shell gawk --version),)
$(error You must have gawk installed on your system!)
else
SHELL := PATH="$(srcdir)/gawkward:$(PATH)" $(SHELL)
endif
endif

newlib: build-gcc-newlib

linux: build-gcc-linux-stage2

native: build-gcc-native

build-binutils-newlib:
	rm -rf $@
	mkdir $@
	cd $@ && $(srcdir)/binutils-$(BINUTILS_VERSION)/configure \
		--target=riscv-elf \
		--program-prefix=riscv- \
		--prefix=$(INSTALL_DIR) \
		--enable-shared \
		--enable-tls \
		--enable-languages=c \
		--with-newlib
	$(MAKE) -C $@ -j $(MAKE_JOBS)
	$(MAKE) -C $@ -j $(MAKE_JOBS) install

build-gcc-newlib-src: build-binutils-newlib
	cp -r $(srcdir)/gcc-$(GCC_VERSION) $@
	cp -r $(srcdir)/newlib-$(NEWLIB_VERSION)/newlib $@
	cp -r $(srcdir)/newlib-$(NEWLIB_VERSION)/libgloss $@

build-gcc-newlib: build-gcc-newlib-src
	rm -rf $@
	mkdir $@
	cd $@ && ../$</configure \
		--target=riscv-elf \
		--program-prefix=riscv- \
		--prefix=$(INSTALL_DIR) \
		--disable-shared \
		--disable-threads \
		--enable-tls \
		--enable-languages=c,c++ \
		--with-newlib \
		--disable-libmudflap \
		--disable-libssp \
		--disable-libquadmath \
		--disable-libgomp \
		--disable-nls
	$(MAKE) -C $@ -j $(MAKE_JOBS) inhibit-libc=true
	$(MAKE) -C $@ -j $(MAKE_JOBS) install

build-binutils-linux:
	rm -rf $@
	mkdir $@
	cd $@ && $(srcdir)/binutils-$(BINUTILS_VERSION)/configure \
		--target=riscv-linux \
		--prefix=$(INSTALL_DIR) \
		--enable-tls \
		--enable-languages=c \
		--with-newlib \
		--disable-multilib
	$(MAKE) -C $@ -j $(MAKE_JOBS)
	$(MAKE) -C $@ -j $(MAKE_JOBS) install

build-gcc-linux-stage1: build-binutils-linux
	rm -rf $@
	mkdir $@
	cd $@ && $(srcdir)/gcc-$(GCC_VERSION)/configure \
		--target=riscv-linux \
		--prefix=$(INSTALL_DIR) \
		--enable-shared \
		--disable-threads \
		--enable-tls \
		--enable-languages=c \
		--with-newlib \
		--disable-libmudflap \
		--disable-libssp \
		--disable-libquadmath \
		--disable-libgomp \
		--disable-nls \
		--disable-multilib \
		--disable-bootstrap
	-$(MAKE) -C $@ -j $(MAKE_JOBS) inhibit-libc=true
	$(MAKE) -C $@ -j $(MAKE_JOBS) install

build-glibc-linux: build-gcc-linux-stage1
	rm -rf $@
	mkdir $@
	cd $@ && $(srcdir)/glibc-$(GLIBC_VERSION)/configure \
		riscv-linux \
		--target=riscv-linux \
		--prefix=$(INSTALL_DIR)/riscv-linux \
		libc_cv_forced_unwind=yes \
		libc_cv_c_cleanup=yes \
		--enable-shared \
		--enable-__thread \
		--disable-multilib \
		--enable-add-ons=nptl \
		--with-headers=$(LINUX_DIR)/include
	$(MAKE) -C $@ -j $(MAKE_JOBS) cross-compiling=yes
	$(MAKE) -C $@ -j $(MAKE_JOBS) install cross-compiling=yes

build-gcc-linux-stage2: build-glibc-linux
	rm -rf $@
	mkdir $@
	cd $@ && $(srcdir)/gcc-$(GCC_VERSION)/configure \
		--target=riscv-linux \
		--prefix=$(INSTALL_DIR) \
		--enable-shared \
		--disable-threads \
		--enable-tls \
		--enable-languages=c,c++ \
		--disable-libmudflap \
		--disable-libssp \
		--disable-libquadmath \
		--disable-libgomp \
		--disable-nls \
		--disable-multilib \
		--disable-bootstrap \
		--with-headers=$(LINUX_DIR)/include
	$(MAKE) -C $@ -j $(MAKE_JOBS)
	$(MAKE) -C $@ -j $(MAKE_JOBS) install

build-binutils-native:
	rm -rf $@
	mkdir $@
	cd $@ && $(srcdir)/binutils-$(BINUTILS_VERSION)/configure \
		--host=riscv-linux \
		--target=riscv-linux \
		--prefix=$(SYSROOT)/usr/ \
		--with-sysroot=/ \
		--disable-multilib \
		--disable-nls
	$(MAKE) -C $@ -j $(MAKE_JOBS)
	$(MAKE) -C $@ -j $(MAKE_JOBS) install

obtain-libraries:
	curl ftp://ftp.gnu.org/gnu/gmp/gmp-$(GMP_VERSION).tar.xz | tar -xJ
	cp native-patches/gmp-configfsf.sub gmp-$(GMP_VERSION)/configfsf.sub
	mv gmp-$(GMP_VERSION) gcc-$(GCC_VERSION)/gmp
	curl http://www.multiprecision.org/mpc/download/mpc-$(MPC_VERSION).tar.gz | tar -xz
	cp native-patches/mpc-config.sub mpc-$(MPC_VERSION)/config.sub
	mv mpc-$(MPC_VERSION) gcc-$(GCC_VERSION)/mpc
	curl http://www.mpfr.org/mpfr-current/mpfr-$(MPFR_VERSION).tar.xz | tar -xJ
	cp native-patches/mpfr-config.sub mpfr-$(MPFR_VERSION)/config.sub
	mv mpfr-$(MPFR_VERSION) gcc-$(GCC_VERSION)/mpfr

build-gcc-native: build-binutils-native obtain-libraries
	rm -rf $@
	mkdir $@
	cd $@ && CFLAGS="-fPIC" $(srcdir)/gcc-$(GCC_VERSION)/configure \
		--host=riscv-linux \
		--target=riscv-linux \
		--prefix=$(SYSROOT)/usr/ \
		--with-sysroot=/ \
		--enable-shared \
		--disable-threads \
		--enable-tls \
		--enable-languages=c \
		--disable-libmudflap \
		--disable-libssp \
		--disable-libquadmath \
		--disable-libgomp \
		--disable-nls \
		--disable-multilib \
		--disable-bootstrap \
		--with-mpfr-include=$(srcdir)/gcc-$(GCC_VERSION)/mpfr/src \
		--with-mpfr-lib=$(srcdir)/$@/mpfr/src/.libs
	$(MAKE) -C $@ -j $(MAKE_JOBS)
	$(MAKE) -C $@ -j $(MAKE_JOBS) install
	rm -rf gcc-$(GCC_VERSION)/{mpfr,gmp,mpc}

clean:
	rm -rf build-*

# the newlib and linux targets perform installation, so this does nothing
install:
